apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nextcloud
  namespace: argocd
spec:
  syncPolicy:
    automated:
      prune: true
      selfHeal: false
      allowEmpty: false
    syncOptions:
      - CreateNamespace=true
  project: default
  destination:
    server: https://kubernetes.default.svc
    namespace: nextcloud
  sources:
    - repoURL: https://github.com/kubelize/kube-projects
      targetRevision: dev
      path: base/stable/nextcloud/deploy
    - repoURL: https://nextcloud.github.io/helm/
      targetRevision: 6.6.2
      chart: nextcloud
      helm:
        parameters: []
        valuesObject:
          image:
            flavour: 
            repository: nextcloud
            tag: 30.0.4-fpm-alpine
          ingress:
            enabled: true
            className: nginx
            annotations:
              nginx.ingress.kubernetes.io/proxy-body-size: 4G
              kubernetes.io/tls-acme: "true"
              cert-manager.io/cluster-issuer: letsencrypt-prod-nginx
              nginx.ingress.kubernetes.io/server-snippet: |-
                server_tokens off;
                proxy_hide_header X-Powered-By;
                rewrite ^/.well-known/webfinger /index.php/.well-known/webfinger last;
                rewrite ^/.well-known/nodeinfo /index.php/.well-known/nodeinfo last;
                rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
                rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json;
                location = /.well-known/carddav {
                  return 301 $scheme://$host/remote.php/dav;
                }
                location = /.well-known/caldav {
                  return 301 $scheme://$host/remote.php/dav;
                }
                location = /robots.txt {
                  allow all;
                  log_not_found off;
                  access_log off;
                }
                location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/ {
                  deny all;
                }
                location ~ ^/(?:autotest|occ|issue|indie|db_|console) {
                  deny all;
                }
            tls:
              - secretName: nextcloud-tls
                hosts:
                  - nextcloud.kube.home
          nginx:
            enabled: true
            image:
              repository: nginxinc/nginx-unprivileged
              tag: alpine3.20
            securityContext:
              runAsUser: 82
              runAsGroup: 33
              runAsNonRoot: true
              readOnlyRootFilesystem: false
            config:
              # This generates the default nginx config as per the nextcloud documentation
              default: false
              custom: |-
                error_log /var/log/nginx/error.log warn;

                events {
                    worker_connections 1024;
                }

                http {
                    include /etc/nginx/mime.types;
                    default_type application/octet-stream;

                    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                                      '$status $body_bytes_sent "$http_referer" '
                                      '"$http_user_agent" "$http_x_forwarded_for"';

                    access_log /var/log/nginx/access.log main;

                    sendfile on;
                    keepalive_timeout 65;

                    upstream php-handler {
                        server 127.0.0.1:9000;
                    }

                    server {
                        listen 8080;
                        
                        # Your server configurations continue here...
                        add_header Referrer-Policy "no-referrer" always;
                        add_header X-Content-Type-Options "nosniff" always;
                        add_header X-Download-Options "noopen" always;
                        add_header X-Frame-Options "SAMEORIGIN" always;
                        add_header X-Permitted-Cross-Domain-Policies "none" always;
                        add_header X-Robots-Tag "none" always;
                        add_header X-XSS-Protection "1; mode=block" always;

                        fastcgi_hide_header X-Powered-By;

                        root /usr/share/nginx/html;

                        location = /robots.txt {
                            allow all;
                            log_not_found off;
                            access_log off;
                        }

                        location = /.well-known/carddav {
                            return 301 $scheme://$host:$server_port/remote.php/dav;
                        }

                        location = /.well-known/caldav {
                            return 301 $scheme://$host:$server_port/remote.php/dav;
                        }

                        client_max_body_size 10G;
                        fastcgi_buffers 64 4K;

                        gzip on;
                        gzip_vary on;
                        gzip_comp_level 4;
                        gzip_min_length 256;
                        gzip_proxied expired no-cache no-store private no_last_modified no_etag auth;
                        gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;

                        location / {
                            rewrite ^ /index.php;
                        }

                        location ~ ^\/(?:build|tests|config|lib|3rdparty|templates|data)\/ {
                            deny all;
                        }
                        location ~ ^\/(?:\.|autotest|occ|issue|indie|db_|console) {
                            deny all;
                        }

                        location ~ ^\/(?:index|remote|public|cron|core\/ajax\/update|status|ocs\/v[12]|updater\/.+|oc[ms]-provider\/.+)\.php(?:$|\/) {
                            fastcgi_split_path_info ^(.+?\.php)(\/.*|)$;
                            set $path_info $fastcgi_path_info;
                            try_files $fastcgi_script_name =404;
                            include fastcgi_params;
                            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                            fastcgi_param PATH_INFO $path_info;

                            fastcgi_param modHeadersAvailable true;
                            fastcgi_param front_controller_active true;
                            fastcgi_pass php-handler;
                            fastcgi_intercept_errors on;
                            fastcgi_request_buffering off;
                        }

                        location ~ ^\/(?:updater|oc[ms]-provider)(?:$|\/) {
                            try_files $uri/ =404;
                            index index.php;
                        }

                        location ~ \.(?:css|js|woff2?|svg|gif|map)$ {
                            try_files $uri /index.php$request_uri;
                            add_header Cache-Control "public, max-age=15778463";
                            add_header Referrer-Policy "no-referrer" always;
                            add_header X-Content-Type-Options "nosniff" always;
                            add_header X-Download-Options "noopen" always;
                            add_header X-Frame-Options "SAMEORIGIN" always;
                            add_header X-Permitted-Cross-Domain-Policies "none" always;
                            add_header X-Robots-Tag "none" always;
                            add_header X-XSS-Protection "1; mode=block" always;
                            access_log off;
                        }

                        location ~ \.(?:png|html|ttf|ico|jpg|jpeg|bcmap)$ {
                            try_files $uri /index.php$request_uri;
                            access_log off;
                        }
                    }
                }
          nextcloud:
            username: admin
            password: initial-access-1234!
            containerPort: 8080
            securityContext:
              runAsUser: 82
              runAsGroup: 33
              runAsNonRoot: true
              readOnlyRootFilesystem: false
            podSecurityContext:
              fsGroup: 33
            extraVolumes:
              - name: before-starting-scripts
                configMap:
                  name: before-starting-scripts
                  defaultMode: 0550
            extraVolumeMounts:
              - name: before-starting-scripts
                mountPath: /docker-entrypoint-hooks.d/before-starting/install-apps.sh
                subPath: install-apps.sh
          externalDatabase:
            enabled: true
            type: mysql
            database: nextcloud
            existingSecret:
              enabled: true
              secretName: "nextcloud-mariadb-auth"
              usernameKey: mariadb-username
              passwordKey: mariadb-password
          mariadb:
            enabled: true
            image: 
              tag: 11.3.2-debian-12-r5
            auth:
              existingSecret: "nextcloud-mariadb-auth"
            primary:
              persistence:
                enabled: true
          redis:
            enabled: true
            image: 
              tag: 7.2.5-debian-12-r4
            auth:
              enabled: true
              existingSecret: "nextcloud-redis-auth"
              existingSecretPasswordKey: "redis-password"
          persisitence:
            enabled: false
